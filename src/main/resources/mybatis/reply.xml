<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dev.mvc.reply.ReplyDAOInter">
<!-- 리뷰 조회 -->
<select  id="reply_list" parameterType="int" resultType="dev.mvc.reply.ReplyVO" >
  SELECT replyno,memberno,(SELECT id FROM member WHERE memberno = #{memberno}) as id,recipeno,replycont,rdate,ratingValue
  FROM reply
  WHERE recipeno = #{recipeno}
  ORDER BY rdate ASC
</select>
<!-- 리뷰 작성 -->
<insert id="reply_create" parameterType="dev.mvc.reply.ReplyVO">
  INSERT INTO reply(replyno,memberno,id,recipeno,replycont,rdate,ratingValue) 
  VALUES(reply_seq.nextval,#{memberno}, (SELECT id FROM member WHERE memberno = #{memberno}),#{recipeno},#{replycont, jdbcType=CLOB},sysdate,#{ratingValue})
</insert>
<update id="ratingAVG_cal" parameterType="int">
  UPDATE reply
  SET ratingAvg = (
      SELECT ROUND(AVG(ratingValue), 2)
      FROM reply
      WHERE recipeno = #{recipeno}
      )
  WHERE recipeno = #{recipeno}
</update>
<select id="ratingAVG" parameterType="int" resultType="float" >
  SELECT AVG(ratingValue)
  FROM reply 
  WHERE recipeno = #{recipeno}
</select>


 <select id="list_by_reply_paging" resultType="dev.mvc.reply.ReplyVO" parameterType="HashMap">
   SELECT replyno,memberno,(SELECT id FROM member WHERE memberno = #{memberno})as id,recipeno,replycont,rdate,ratingValue,ratingAVG, r
   FROM (
              SELECT replyno,memberno,(SELECT id FROM member WHERE memberno = #{memberno})as id,recipeno,replycont,rdate,ratingValue,ratingAVG, rownum as r
              FROM (
                        SELECT replyno,memberno,(SELECT id FROM member WHERE memberno = #{memberno})as id,recipeno,replycont,rdate,ratingValue,ratingAVG
                        FROM reply
                        ORDER BY rdate DESC
               )
    )
    WHERE <![CDATA[ r >= #{start_num} AND r <= #{end_num} ]]>
     
    <!--  1 page: WHERE r >= 1 AND r <= 10; 
            2 page: WHERE r >= 11 AND r <= 20;
            3 page: WHERE r >= 21 AND r <= 30; -->
  </select>   
</mapper>